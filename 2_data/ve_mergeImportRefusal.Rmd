---
title: "Merge Refusals with Import Volume"
author: "Vince Egalla"
date: "11/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
options(scipen=999)
```

## Dependencies

```{r}
library(tidyverse)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
```

## Load Data
```{r}
## Combined FDA + USDA data
load("output/build/compositeImportRefusal.Rdata")
```

```{r}
## Cleaned import volume data
import = read.csv("output/build/monthly_cleaned.csv")
```

## Convert refusal data to monthly
```{r}
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")

## Aggregate refusals to a monthly level
monthlyRef = setNames(aggregate(composite$catfish, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusals'))
```

## Convert volume data to monthly
```{r}
## Create Year-Month variable for aggregation
import$yrmonth = format(as.Date(paste(import$year,import$month_number,"01", sep="-")),"%Y-%m")

## Aggregate refusals to a monthly level
monthlyVol = setNames(aggregate(import$volume_kg, by=list(import$yrmonth, import$country_name), FUN= sum), c('yrmonth','country','import_volume'))
```

## Merge monthly data
```{r}
monthly = merge(x= monthlyRef, y= monthlyVol, by= c('yrmonth','country'), all= TRUE, fill= 0)

monthly[is.na(monthly)] = 0
```

## Checks on merge

## Build Variables for regression analysis

```{r}
## Month & Year variables
typeof(monthly$yrmonth)
monthly$year = format(as.Date(paste(monthly$yrmonth,'-01',sep= '')), '%Y')
monthly$month = format(as.Date(paste(monthly$yrmonth,'-01',sep = '')), '%m')

typeof(monthly$year)

## Limit data to 2014 to 2020 February
monthly = monthly[monthly$year >= 2014,]
monthly = monthly[!(monthly$year == 2020 & !(monthly$month == '01' | monthly$month == '02')),]
```

## USDA Authority (Dummy)
```{r}
## Dummy Variable if month year is in or after September 2017
monthly$USDA01 = ifelse(((monthly$year == 2017 & (monthly$month == "09" | monthly$month == "10" | monthly$month == "11" | monthly$month == "12")) 
                         | monthly$year >= 2018), 1, 0)

## Interaction of USDA Authority and Volume
monthly$USDAxVolume = monthly$USDA01 * monthly$import_volume

## Export as CSV for comparison
write.csv(monthly, file="output/build/ve_analysis_dataset.CSV")
```

```

## Linear Regression
```{r}
## Base Model
ols.1 = lm(total_refusals ~ import_volume + USDA01 + USDAxVolume +  factor(month) + factor(country), data= monthly)

summary(ols.1)
```

## Visualization
```{r}
monthly$refusalByVolume = monthly$total_refusals / monthly$import_volume
monthly[is.na(monthly)] = 0
monthly$relevantCountries = ifelse((monthly$country == "VIETNAM" | monthly$country == "CHINA" | monthly$country == "THAILAND"), monthly$country, "All Other Countries")
visualize = setNames(aggregate(monthly$refusalByVolume, by=list(monthly$yrmonth, monthly$relevantCountries), FUN= mean), c('yrmonth','country','refusalsByVolume'))
```

