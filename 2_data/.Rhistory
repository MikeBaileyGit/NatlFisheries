## Get list of column names to merge by
fda_col = colnames(fda)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
## FDA - catfish refusal weight
kg = read_csv("raw/ITACS/FDA_ENTRY_NUM_REVIEW.CSV")
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
## Get list of column names to merge by
fda_col = colnames(fda)
## Dates need to be standardized because the review of ITACS ended up losing leading 0 in "REFUSAL DATE"
fda$REFUSAL_DATE = as.Date(fda$REFUSAL_DATE, format= '%d-%b-%y')
kg$REFUSAL_DATE = as.Date(kg$REFUSAL_DATE, format= '%d-%b-%y')
## Merge weight data
fda = merge(fda, kg, by= fda_col, all.x= TRUE)
## Check count of non-missing weight data
# 52 observations exist for Catfish, but one record related to Nigeria (NG) could not be found in ITACS
fda[(!is.na(fda_kg$Weight_Refused_KG)),]
fda$refusal_weight = ifelse(fda$catfish = 1, fda$Weight_Refused_KG, 0)
fda$refusal_weight = ifelse(fda$catfish == 1, fda$Weight_Refused_KG, 0)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
## FDA - catfish refusal weight
kg = read_csv("raw/ITACS/FDA_ENTRY_NUM_REVIEW.CSV")
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
## Get list of column names to merge by
fda_col = colnames(fda)
## Dates need to be standardized because the review of ITACS ended up losing leading 0 in "REFUSAL DATE"
fda$REFUSAL_DATE = as.Date(fda$REFUSAL_DATE, format= '%d-%b-%y')
kg$REFUSAL_DATE = as.Date(kg$REFUSAL_DATE, format= '%d-%b-%y')
## Merge weight data
fda = merge(fda, kg, by= fda_col, all.x= TRUE)
## Check count of non-missing weight data
# 52 observations exist for Catfish, but one record related to Nigeria (NG) could not be found in ITACS
fda[(!is.na(fda_kg$Weight_Refused_KG)),]
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
## FDA - catfish refusal weight
kg = read_csv("raw/ITACS/FDA_ENTRY_NUM_REVIEW.CSV")
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
## Get list of column names to merge by
fda_col = colnames(fda)
## Dates need to be standardized because the review of ITACS ended up losing leading 0 in "REFUSAL DATE"
fda$REFUSAL_DATE = as.Date(fda$REFUSAL_DATE, format= '%d-%b-%y')
kg$REFUSAL_DATE = as.Date(kg$REFUSAL_DATE, format= '%d-%b-%y')
## Merge weight data
fda = merge(fda, kg, by= fda_col, all.x= TRUE)
## Check count of non-missing weight data
# 52 observations exist for Catfish, but one record related to Nigeria (NG) could not be found in ITACS
fda[(!is.na(fda_kg$Weight_Refused_KG)),]
View(fda)
## Create date variable
fda$date = fda$REFUSAL_DATE
## Check date data type
typeof(usda$received_lot_date)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
## FDA - catfish refusal weight
kg = read_csv("raw/ITACS/FDA_ENTRY_NUM_REVIEW.CSV")
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
## Get list of column names to merge by
fda_col = colnames(fda)
## Dates need to be standardized because the review of ITACS ended up losing leading 0 in "REFUSAL DATE"
fda$REFUSAL_DATE = as.Date(fda$REFUSAL_DATE, format= '%d-%b-%y')
kg$REFUSAL_DATE = as.Date(kg$REFUSAL_DATE, format= '%d-%b-%y')
## Merge weight data
fda = merge(fda, kg, by= fda_col, all.x= TRUE)
## Check count of non-missing weight data
# 52 observations exist for Catfish, but one record related to Nigeria (NG) could not be found in ITACS
fda[(!is.na(fda_kg$Weight_Refused_KG)),]
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
## FDA - catfish refusal weight
kg = read_csv("raw/ITACS/FDA_ENTRY_NUM_REVIEW.CSV")
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
## Get list of column names to merge by
fda_col = colnames(fda)
## Dates need to be standardized because the review of ITACS ended up losing leading 0 in "REFUSAL DATE"
fda$REFUSAL_DATE = as.Date(fda$REFUSAL_DATE, format= '%d-%b-%y')
kg$REFUSAL_DATE = as.Date(kg$REFUSAL_DATE, format= '%d-%b-%y')
## Merge weight data
fda = merge(fda, kg, by= fda_col, all.x= TRUE)
## Check count of non-missing weight data
# 52 observations exist for Catfish, but one record related to Nigeria (NG) could not be found in ITACS
fda[(!is.na(fda$Weight_Refused_KG)),]
## Vertical join of USDA Archived & Current
usda = rbind(usdaCurrent, usdaArchived)
## Check for duplicates after row bind of Archived & Current
usda[duplicated(usda),]
## Check column names
colnames(usda)
## Update column names to remove spacing/breaks
names(usda)[names(usda) == "AppLot\r\nNumber"] = "app_lot_number"
names(usda)[names(usda) == "Country"] = "country"
names(usda)[names(usda) == "Received\r\nLot Date"] = "received_lot_date"
names(usda)[names(usda) == "Export\r\nEstablishment"] = "export_establishment"
names(usda)[names(usda) == "Company\r\nName"] = "company_name"
names(usda)[names(usda) == "HACCP\r\nCode"] = "HACCP_code"
names(usda)[names(usda) == "Product\r\nCategory"] = "product_category"
names(usda)[names(usda) == "Species\r\nName"] = "species_name"
names(usda)[names(usda) == "Final Weight\r\nRefused"] = "final_weight_refused"
names(usda)[names(usda) == "Refusal\r\nReasons"] = "refusal_reasons"
names(usda)[names(usda) == "Failed TOI"] = "failed_TOI"
names(usda)[names(usda) == "Defect\r\nDescriptions"] = "defect_desc"
## Check updated names
colnames(usda)
## FDA Product Description Frequency Table
fda$PRDCT_CODE_DESC_TEXT = tolower(fda$PRDCT_CODE_DESC_TEXT)
## FDA Product Description Frequency Table
fdaProducts = as.data.frame(table(fda$PRDCT_CODE_DESC_TEXT))
## Check product categories given keyword searches
fdaCatfish = fdaProducts[grepl("catfish", fdaProducts$Var1),]
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("pangasius", fdaProducts$Var1),]
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("siluriformes", fdaProducts$Var1),]
## Create catfish dummy for FDA data
fda = mutate(fda, catfish = ifelse(fda$PRDCT_CODE_DESC_TEXT %in% fdaCatfish$Var1, 1, 0))
## Check records flagged with catfish dummy
fda[fda$catfish == 1,]
## Create flag for Product Descriptions that contains words from the FSIS document
fsis.words = as.vector(fsis$word)
pattern = paste(fsis.words, collapse="|")
## Create catfish dummy for FDA data
fda = mutate(fda, fsis= ifelse(grepl(pattern, fda$PRDCT_CODE_DESC_TEXT), 1, 0))
## Check records flagged with catfish dummy
fda[fda$fsis == 1,]
## Product Descriptions flagged by FSIS indicator
fdaFSIS = distinct(fda[fda$fsis==1,], PRDCT_CODE_DESC_TEXT)
## USDA Species Category Description Frequency Table
usdaProducts = as.data.frame(table(usda$species_name))
## Check product categories given keyword searches
usdaCatfish = usdaProducts[grepl("Siluriformes", usdaProducts$Var1),]
## Create catfish dummy for USDA data
usda = mutate(usda, catfish = ifelse(usda$species_name %in% usdaCatfish$Var1, 1, 0))
## Check records flagged with catfish dummy
usda[usda$catfish == 1,]
## Create date variable
fda$date = fda$REFUSAL_DATE
## Check date data type
typeof(usda$received_lot_date)
## Convert to numeric
usda$date = as.Date(usda$received_lot_date, '%Y-%m-%d')
## Convert ISO Country Code to Long Name
# Ambiguous values are not relevant and may be ignored.
fda$country_std = toupper(countrycode(fda$ISO_CNTRY_CODE, origin= 'iso2c', destination= 'country.name'))
## Convert ISO Country Code to Long Name
# Ambiguous values are not relevant and may be ignored.
usda$country_iso = toupper(countrycode(usda$country, origin= 'country.name', destination= 'iso2c'))
usda$country_std = toupper(countrycode(usda$country_iso, origin= 'iso2c', destination= 'country.name'))
fda$refusal_weight = ifelse(fda$catfish == 1, fda$Weight_Refused_KG, 0)
## Specify relevant variables to combine
fdaVars = c("catfish","date","country_std", "MFG_FIRM_FEI_NUM", "LGL_NAME", "ENTRY_NUM","refusal_weight")
## Subset FDA data and add source
fdaSubset = fda[fdaVars]
fdaSubset$source = "FDA"
## Specify relevant variables to combine
usdaVars = c("catfish","date","country_std", "export_establishment", "company_name", "app_lot_number", "product_category", "species_name", "refusal_weight")
## Subset FDA data and add source
usdaSubset = usda[usdaVars]
## Create standardized variable; convert lbs to kg
usda$refusal_weight = ifelse(usda$catfish == 1, usda$final_weight_refused / 2.205, 0)
## Specify relevant variables to combine
fdaVars = c("catfish","date","country_std", "MFG_FIRM_FEI_NUM", "LGL_NAME", "ENTRY_NUM","refusal_weight")
## Subset FDA data and add source
fdaSubset = fda[fdaVars]
fdaSubset$source = "FDA"
## Specify relevant variables to combine
usdaVars = c("catfish","date","country_std", "export_establishment", "company_name", "app_lot_number", "product_category", "species_name", "refusal_weight")
## Subset FDA data and add source
usdaSubset = usda[usdaVars]
usdaSubset$source = "USDA"
## Stack data subsets
composite = rbind.fill(fdaSubset, usdaSubset)
composite
compositeCountries = distinct(composite, country_std)
## Export as RData
save(composite, file="output/build/compositeImportRefusal.RData")
## Export as CSV
write.csv(composite, file="output/build/compositeImportRefusal.CSV")
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
options(scipen=999)
library(tidyverse)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
## Combined FDA + USDA data
load("output/build/compositeImportRefusal.Rdata")
## Cleaned import volume data
import = read.csv("output/build/monthly_cleaned.csv")
View(composite)
View(composite)
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusal instances to a monthly level
monthlyNRef = setNames(aggregate(composite$catfish, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusals'))
## Aggregate refusal weight to a monthly level
monthlyNRef = setNames(aggregate(composite$refusal_weight, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusal instances to a monthly level
monthlyNRef = setNames(aggregate(composite$catfish, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusals'))
## Aggregate refusal weight to a monthly level
monthlyNKG = setNames(aggregate(composite$refusal_weight, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusal_weight'))
View(monthlyNKG)
View(monthlyNRef)
View(monthlyNRef)
View(monthlyNKG)
View(monthlyNRef)
## Create Year-Month variable for aggregation
import$yrmonth = format(as.Date(paste(import$year,import$month_number,"01", sep="-")),"%Y-%m")
## Aggregate refusals to a monthly level
monthlyVol = setNames(aggregate(import$volume_kg, by=list(import$yrmonth, import$country_name), FUN= sum), c('yrmonth','country','import_volume'))
## Manual conversion of records with import refusal but no import volume for given month-country
# China - March 2016 -> February 2016
monthlyRef[monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA",]
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
options(scipen=999)
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusal weight to a monthly level
monthlyRef = setNames(aggregate(composite$refusal_weight, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusal_weight'))
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
options(scipen=999)
library(tidyverse)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
## Combined FDA + USDA data
load("output/build/compositeImportRefusal.Rdata")
## Cleaned import volume data
import = read.csv("output/build/monthly_cleaned.csv")
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusal weight to a monthly level
monthlyRef = setNames(aggregate(composite$refusal_weight, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Create Year-Month variable for aggregation
import$yrmonth = format(as.Date(paste(import$year,import$month_number,"01", sep="-")),"%Y-%m")
## Aggregate refusals to a monthly level
monthlyVol = setNames(aggregate(import$volume_kg, by=list(import$yrmonth, import$country_name), FUN= sum), c('yrmonth','country','import_volume'))
## Manual conversion of records with import refusal but no import volume for given month-country
# China - March 2016 -> February 2016
monthlyRef[monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA",]
monthlyRef$total_refusals[(monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA")] = format(as.Date("2016-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2016-02" & monthlyRef$country == "CHINA",]
# Thailand - January 2018 -> November 2017 (Latest 2017 record)
monthlyRef[monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND")] = format(as.Date("2017-11-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2017-11" & monthlyRef$country == "THAILAND",]
# Thailand - May 2018 -> February 2018 (No other records in 2018)
monthlyRef[monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND")] = format(as.Date("2018-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2018-02" & monthlyRef$country == "THAILAND",]
monthlyRef = setNames(aggregate(as.numeric(monthlyRef$total_refusals), by=list(monthlyRef$yrmonth, monthlyRef$country), FUN= sum), c('yrmonth','country','total_refusals'))
# Limit to observations with import volume
monthly = merge(x= monthlyRef, y= monthlyVol, by= c('yrmonth','country'), all.y= TRUE, fill= 0)
monthly[is.na(monthly)] = 0
## Month & Year variables
typeof(monthly$yrmonth)
monthly$year = format(as.Date(paste(monthly$yrmonth,'-01',sep= '')), '%Y')
monthly$month = format(as.Date(paste(monthly$yrmonth,'-01',sep = '')), '%m')
typeof(monthly$year)
## Limit data to 2014 (FDA start) to 2020 February (USDA end)
monthly = monthly[monthly$year >= 2014,]
monthly = monthly[!(monthly$year == 2020 & !(monthly$month == '01' | monthly$month == '02')),]
## Dummy Variable if month year is in or after September 2017
monthly$USDA01 = ifelse(((monthly$year == 2017 & (monthly$month == "09" | monthly$month == "10" | monthly$month == "11" | monthly$month == "12"))
| monthly$year >= 2018), 1, 0)
## Interaction of USDA Authority and Volume
monthly$USDAxVolume = monthly$USDA01 * monthly$import_volume
## Export as CSV for comparison
write.csv(monthly, file="output/build/ve_analysis_dataset.CSV")
## Base Model
ols.1 = lm(total_refusals ~ import_volume + USDA01 + USDAxVolume +  factor(month) + factor(country), data= monthly)
summary(ols.1)
monthly$refusalByVolume = monthly$total_refusals / monthly$import_volume
monthly[is.na(monthly)] = 0
monthly$relevantCountries = ifelse((monthly$country == "VIETNAM" | monthly$country == "CHINA" | monthly$country == "THAILAND"), monthly$country, "All Other Countries")
visualize = setNames(aggregate(monthly$refusalByVolume, by=list(monthly$yrmonth, monthly$relevantCountries), FUN= mean), c('yrmonth','country','refusalsByVolume'))
## Monthly refusals over time period (Vietnam)
ggplot(visualize, aes(x= yrmonth, y= refusalsByVolume, group= country, fill= country)) +
geom_line() +
labs(x= "Year-Month", y= "Proportion of Refusals by Volume", title= "Catfish Import Refusals Proportion of Volume\nfrom January 2014 to February 2020") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5))+
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 0.01, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 0.01, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2019-11", linetype= "dashed", color= "darkred") + annotate("text", x= "2019-12", y= 0.01, color= "darkred", label= "November 2019\nVietnam gains FSIS\nequivalence", hjust= 0, vjust= 1)
## Manual conversion of records with import refusal but no import volume for given month-country
# China - March 2016 -> February 2016
monthlyRef[monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA",]
monthlyRef$total_refusals[(monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA")] = format(as.Date("2016-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2016-02" & monthlyRef$country == "CHINA",]
# Thailand - January 2018 -> November 2017 (Latest 2017 record)
monthlyRef[monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND")] = format(as.Date("2017-11-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2017-11" & monthlyRef$country == "THAILAND",]
# Thailand - May 2018 -> February 2018 (No other records in 2018)
monthlyRef[monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND")] = format(as.Date("2018-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2018-02" & monthlyRef$country == "THAILAND",]
monthlyRef = setNames(aggregate(as.numeric(monthlyRef$total_refusals), by=list(monthlyRef$yrmonth, monthlyRef$country), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Cleaned import volume data
import = read.csv("output/build/monthly_cleaned.csv")
## Combined FDA + USDA data
load("output/build/compositeImportRefusal.Rdata")
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusal weight to a monthly level
monthlyRef = setNames(aggregate(composite$refusal_weight, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Create Year-Month variable for aggregation
import$yrmonth = format(as.Date(paste(import$year,import$month_number,"01", sep="-")),"%Y-%m")
## Aggregate refusals to a monthly level
monthlyVol = setNames(aggregate(import$volume_kg, by=list(import$yrmonth, import$country_name), FUN= sum), c('yrmonth','country','import_volume'))
## Manual conversion of records with import refusal but no import volume for given month-country
# China - March 2016 -> February 2016
monthlyRef[monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA",]
monthlyRef$total_refusals[(monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA")] = format(as.Date("2016-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2016-02" & monthlyRef$country == "CHINA",]
# Thailand - January 2018 -> November 2017 (Latest 2017 record)
monthlyRef[monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND")] = format(as.Date("2017-11-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2017-11" & monthlyRef$country == "THAILAND",]
# Thailand - May 2018 -> February 2018 (No other records in 2018)
monthlyRef[monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND")] = format(as.Date("2018-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2018-02" & monthlyRef$country == "THAILAND",]
monthlyRef = setNames(aggregate(as.numeric(monthlyRef$total_refusals), by=list(monthlyRef$yrmonth, monthlyRef$country), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Manual conversion of records with import refusal but no import volume for given month-country
# China - March 2016 -> February 2016
monthlyRef[monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA",]
monthlyRef$total_refusals[(monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA")] = format(as.Date("2016-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2016-02" & monthlyRef$country == "CHINA",]
# Thailand - January 2018 -> November 2017 (Latest 2017 record)
monthlyRef[monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND")] = format(as.Date("2017-11-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2017-11" & monthlyRef$country == "THAILAND",]
# Thailand - May 2018 -> February 2018 (No other records in 2018)
monthlyRef[monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND")] = format(as.Date("2018-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2018-02" & monthlyRef$country == "THAILAND",]
monthlyRef = setNames(aggregate(as.numeric(monthlyRef$total_refusal_weight), by=list(monthlyRef$yrmonth, monthlyRef$country), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Combined FDA + USDA data
load("output/build/compositeImportRefusal.Rdata")
## Cleaned import volume data
import = read.csv("output/build/monthly_cleaned.csv")
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusal weight to a monthly level
monthlyRef = setNames(aggregate(composite$refusal_weight, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Create Year-Month variable for aggregation
import$yrmonth = format(as.Date(paste(import$year,import$month_number,"01", sep="-")),"%Y-%m")
## Aggregate refusals to a monthly level
monthlyVol = setNames(aggregate(import$volume_kg, by=list(import$yrmonth, import$country_name), FUN= sum), c('yrmonth','country','import_volume'))
## Manual conversion of records with import refusal but no import volume for given month-country
# China - March 2016 -> February 2016
monthlyRef[monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA",]
monthlyRef$total_refusals[(monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA")] = format(as.Date("2016-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2016-02" & monthlyRef$country == "CHINA",]
# Thailand - January 2018 -> November 2017 (Latest 2017 record)
monthlyRef[monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND")] = format(as.Date("2017-11-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2017-11" & monthlyRef$country == "THAILAND",]
# Thailand - May 2018 -> February 2018 (No other records in 2018)
monthlyRef[monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND")] = format(as.Date("2018-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2018-02" & monthlyRef$country == "THAILAND",]
monthlyRef = setNames(aggregate(as.numeric(monthlyRef$total_refusal_weight), by=list(monthlyRef$yrmonth, monthlyRef$country), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Combined FDA + USDA data
load("output/build/compositeImportRefusal.Rdata")
## Cleaned import volume data
import = read.csv("output/build/monthly_cleaned.csv")
## Create Year-Month variable for aggregation
composite$yrmonth = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusal weight to a monthly level
monthlyRef = setNames(aggregate(composite$refusal_weight, by=list(composite$yrmonth, composite$country_std), FUN= sum), c('yrmonth','country','total_refusal_weight'))
## Create Year-Month variable for aggregation
import$yrmonth = format(as.Date(paste(import$year,import$month_number,"01", sep="-")),"%Y-%m")
## Aggregate refusals to a monthly level
monthlyVol = setNames(aggregate(import$volume_kg, by=list(import$yrmonth, import$country_name), FUN= sum), c('yrmonth','country','import_volume'))
## Manual conversion of records with import refusal but no import volume for given month-country
# China - March 2016 -> February 2016
monthlyRef[monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2016-03" & monthlyRef$country == "CHINA")] = format(as.Date("2016-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2016-02" & monthlyRef$country == "CHINA",]
# Thailand - January 2018 -> November 2017 (Latest 2017 record)
monthlyRef[monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-01" & monthlyRef$country == "THAILAND")] = format(as.Date("2017-11-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2017-11" & monthlyRef$country == "THAILAND",]
# Thailand - May 2018 -> February 2018 (No other records in 2018)
monthlyRef[monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND",]
monthlyRef$yrmonth[(monthlyRef$yrmonth == "2018-05" & monthlyRef$country == "THAILAND")] = format(as.Date("2018-02-01"),"%Y-%m")
monthlyRef[monthlyRef$yrmonth == "2018-02" & monthlyRef$country == "THAILAND",]
monthlyRef = setNames(aggregate(as.numeric(monthlyRef$total_refusal_weight), by=list(monthlyRef$yrmonth, monthlyRef$country), FUN= sum), c('yrmonth','country','total_refusal_weight'))
# Limit to observations with import volume
monthly = merge(x= monthlyRef, y= monthlyVol, by= c('yrmonth','country'), all.y= TRUE, fill= 0)
monthly[is.na(monthly)] = 0
View(monthly)
## Month & Year variables
typeof(monthly$yrmonth)
monthly$year = format(as.Date(paste(monthly$yrmonth,'-01',sep= '')), '%Y')
monthly$month = format(as.Date(paste(monthly$yrmonth,'-01',sep = '')), '%m')
typeof(monthly$year)
## Limit data to 2014 (FDA start) to 2020 February (USDA end)
monthly = monthly[monthly$year >= 2014,]
monthly = monthly[!(monthly$year == 2020 & !(monthly$month == '01' | monthly$month == '02')),]
## Dummy Variable if month year is in or after September 2017
monthly$USDA01 = ifelse(((monthly$year == 2017 & (monthly$month == "09" | monthly$month == "10" | monthly$month == "11" | monthly$month == "12"))
| monthly$year >= 2018), 1, 0)
## Interaction of USDA Authority and Volume
monthly$USDAxVolume = monthly$USDA01 * monthly$import_volume
## Export as CSV for comparison
write.csv(monthly, file="output/build/ve_analysis_dataset.CSV")
## Base Model
ols.1 = lm(total_refusals ~ import_volume + USDA01 + USDAxVolume +  factor(month) + factor(country), data= monthly)
## Base Model
ols.1 = lm(total_refusal_weight ~ import_volume + USDA01 + USDAxVolume +  factor(month) + factor(country), data= monthly)
summary(ols.1)
monthly$refusalByVolume = monthly$total_refusal_weight / monthly$import_volume
monthly[is.na(monthly)] = 0
monthly$relevantCountries = ifelse((monthly$country == "VIETNAM" | monthly$country == "CHINA" | monthly$country == "THAILAND"), monthly$country, "All Other Countries")
visualize = setNames(aggregate(monthly$refusalByVolume, by=list(monthly$yrmonth, monthly$relevantCountries), FUN= mean), c('yrmonth','country','refusalsByVolume'))
## Monthly refusals over time period (Vietnam)
ggplot(visualize, aes(x= yrmonth, y= refusalsByVolume, group= country, fill= country)) +
geom_line() +
labs(x= "Year-Month", y= "Proportion of Refusals by Volume", title= "Catfish Import Refusals Proportion of Volume\nfrom January 2014 to February 2020") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5))+
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 0.01, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 0.01, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2019-11", linetype= "dashed", color= "darkred") + annotate("text", x= "2019-12", y= 0.01, color= "darkred", label= "November 2019\nVietnam gains FSIS\nequivalence", hjust= 0, vjust= 1)
