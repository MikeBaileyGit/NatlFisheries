geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2019-11", linetype= "dashed", color= "darkred") + annotate("text", x= "2019-12", y= 120, color= "darkred", label= "November 2019\nVietnam gains FSIS\nequivalence", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalAllCountries.png")
## Countries listed
compCountries = as.data.frame(table(composite$country))
## Aggregate refusals to a monthly level for Vietnam
compVietnam = composite[composite$country=="VIETNAM",]
monthlyVietnam = aggregate(compVietnam$catfish, by=list(category= compVietnam$month), FUN= sum)
## Monthly refusals over time period (Vietnam)
ggplot(monthlyVietnam, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor Vietnam") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2019-11", linetype= "dashed", color= "darkred") + annotate("text", x= "2019-12", y= 120, color= "darkred", label= "November 2019\nVietnam gains FSIS\nequivalence", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalVietnam.png")
## Aggregate refusals to a monthly level for China
compChina = composite[composite$country=="CHINA",]
monthlyChina = aggregate(compChina$catfish, by=list(category= compChina$month), FUN= sum)
## Monthly refusals over time period (China)
ggplot(monthlyChina, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor China") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalChina.png")
## Aggregate refusals to a monthly level for Thailand
compThailand = composite[composite$country=="THAILAND",]
monthlyThailand = aggregate(compThailand$catfish, by=list(category= compThailand$month), FUN= sum)
## Monthly refusals over time period
ggplot(monthlyThailand, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor Thailand") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalThailand.png")
## Aggregate refusals to a monthly level for Thailand
compOther = composite[composite$country!="VIETNAM"&composite$country!="CHINA"&composite$country!="THAILAND",]
monthlyOther = aggregate(compOther$catfish, by=list(category= compOther$month), FUN= sum)
monthlyVietnam$country = "Vietnam"
monthlyChina$country = "China"
monthlyThailand$country = "Thailand"
monthlyOther$country = "All Other Countries"
## Merge all monthly data
monthlyByCountryLong= Reduce(function(x, y) rbind(x, y), list(monthlyVietnam, monthlyChina, monthlyThailand, monthlyOther))
monthlyByCountryLong$yearmon = as.numeric(parse_date_time(monthlyByCountryLong$category, orders= "ym"))
class(monthlyByCountryLong$yearmon)
## Monthly refusals over time period (Stacked Bar)
ggplot(monthlyByCountryLong, aes(x= category, y= x, fill= country)) +
geom_bar(position= "stack", stat= "identity") +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nBy Country", fill= "Country") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120)  +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalByCountryBar.png")
## Monthly refusals over time period (Area Attempt)
ggplot(monthlyByCountryLong, aes(x= yearmon, y= x, fill= country)) +
geom_area(alpha= 0.5, color= 'black') +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nBy Country", fill= "Country") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120)
ggsave("output/figures/refusals/monthlyImportRefusalByCountryArea.png")
View(monthly)
View(monthlyByCountryLong)
View(monthly)
typeof(monthly$category)
View(monthly)
View(monthly)
typeof(monthly$category)
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
print(paste("The average number of import refusals before September 2017 is ",preAvg))
}
avgRefusalsPrePostSep2017(monthly)
print(paste("The average number of import refusals on and after September 2017 is ", postAvg, "."))
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
print(paste("The average number of import refusals before September 2017 is ", preAvg, "."))
print(paste("The average number of import refusals on and after September 2017 is ", postAvg, "."))
}
avgRefusalsPrePostSep2017(monthly)
print(paste("After shifting authority to the USDA, the average number of refusals changed by ", deltaAvg, "%."))
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
deltaAvg = (postAvg - preAvg)/preAvg
print(paste("The average number of import refusals before September 2017 is ", preAvg, "."))
print(paste("The average number of import refusals on and after September 2017 is ", postAvg, "."))
print(paste("After shifting authority to the USDA, the average number of refusals changed by ", deltaAvg, "%."))
}
avgRefusalsPrePostSep2017(monthly)
deltaAvg = (postAvg - preAvg)/preAvg * 100
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
deltaAvg = (postAvg - preAvg)/preAvg * 100
print(paste("The average number of import refusals before September 2017 is ", round(preAvg,2), "."))
print(paste("The average number of import refusals on and after September 2017 is ", round(postAvg,2), "."))
print(paste("After shifting authority to the USDA, the average number of refusals changed by ", round(deltaAvg,2(), "%."))
}
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
deltaAvg = (postAvg - preAvg)/preAvg * 100
print(paste("The average number of import refusals before September 2017 is ", round(preAvg,2), "."))
print(paste("The average number of import refusals on and after September 2017 is ", round(postAvg,2), "."))
print(paste("After shifting authority to the USDA, the average number of refusals changed by ", round(deltaAvg,2), "%."))
}
avgRefusalsPrePostSep2017(monthly)
avgRefusalPrePostSep2017(montlhyChina)
avgRefusalsPrePostSep2017(montlhyVietnam)
View(monthlyVietnam)
avgRefusalsPrePostSep2017(monthlyVietnam)
avgRefusalsPrePostSep2017(monthlyChina)
avgRefusalsPrePostSep2017(monthlyThailan)
avgRefusalsPrePostSep2017(monthlyThailand)
deltaAvg = (postAvg - preAvg)/preAvg
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
deltaAvg = (postAvg - preAvg)/preAvg
print(paste("The average number of import refusals before September 2017 is ", round(preAvg,2), "."))
print(paste("The average number of import refusals on and after September 2017 is ", round(postAvg,2), "."))
print(paste("After shifting authority to the USDA, the average number of refusals changed by ", round(deltaAvg,2), "%."))
}
avgRefusalsPrePostSep2017(monthly)
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
deltaAvg = (postAvg - preAvg)/preAvg * 100
print(paste("The average number of import refusals before September 2017 is ", round(preAvg,2), "."))
print(paste("The average number of import refusals on and after September 2017 is ", round(postAvg,2), "."))
print(paste("After shifting authority to the USDA, the average number of refusals changed by ", round(deltaAvg,2), "%."))
}
avgRefusalsPrePostSep2017(monthly)
## Monthly refusals over time period (Vietnam)
ggplot(monthlyVietnam, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor Vietnam") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred", hjust= 0) + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2019-11", linetype= "dashed", color= "darkred") + annotate("text", x= "2019-12", y= 120, color= "darkred", label= "November 2019\nVietnam gains FSIS\nequivalence", hjust= 0, vjust= 1)
View(composite)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
## Vertical join of USDA Archived & Current
usda = rbind(usdaCurrent, usdaArchived)
## Check for duplicates after row bind of Archived & Current
usda[duplicated(usda),]
## Check column names
colnames(usda)
## Update column names
names(usda)[names(usda) == "AppLot\r\nNumber"] = "app_lot_number"
names(usda)[names(usda) == "Country"] = "country"
names(usda)[names(usda) == "Received\r\nLot Date"] = "received_lot_date"
names(usda)[names(usda) == "Export\r\nEstablishment"] = "export_establishment"
names(usda)[names(usda) == "Company\r\nName"] = "company_name"
names(usda)[names(usda) == "HACCP\r\nCode"] = "HACCP_code"
names(usda)[names(usda) == "Product\r\nCategory"] = "product_category"
names(usda)[names(usda) == "Species\r\nName"] = "species_name"
names(usda)[names(usda) == "Final Weight\r\nRefused"] = "final_weight_refused"
names(usda)[names(usda) == "Refusal\r\nReasons"] = "refusal_reasons"
names(usda)[names(usda) == "Failed TOI"] = "failed_TOI"
names(usda)[names(usda) == "Defect\r\nDescriptions"] = "defect_desc"
## Check updated names
colnames(usda)
#fsis = extract_tables("FSIS/Siluriformes-Fish-Species-FSIS.pdf")
## FDA Product Description Frequency Table
fda$PRDCT_CODE_DESC_TEXT = tolower(fda$PRDCT_CODE_DESC_TEXT)
## FDA Product Description Frequency Table
fdaProducts = as.data.frame(table(fda$PRDCT_CODE_DESC_TEXT))
## Check product categories given keyword searches
fdaCatfish = fdaProducts[grepl("catfish", fdaProducts$Var1),]
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("pangasius", fdaProducts$Var1),]
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("siluriformes", fdaProducts$Var1),]
## Create flag for Product Descriptions that contains words from the FSIS document
fsis.words = as.vector(fsis$word)
pattern = paste(fsis.words, collapse="|")
## Create catfish dummy for FDA data
fda = mutate(fda, fsis= ifelse(grepl(pattern, fda$PRDCT_CODE_DESC_TEXT), 1, 0))
## Check records flagged with catfish dummy
fda[fda$fsis == 1,]
## Product Descriptions flagged by FSIS indicator
fdaFSIS = distinct(fda[fda$fsis==1,], PRDCT_CODE_DESC_TEXT)
## USDA Species Category Description Frequency Table
usdaProducts = as.data.frame(table(usda$species_name))
## Check product categories given keyword searches
usdaCatfish = usdaProducts[grepl("Siluriformes", usdaProducts$Var1),]
## Create catfish dummy for FDA data
usda = mutate(usda, catfish = ifelse(usda$species_name %in% usdaCatfish$Var1, 1, 0))
## Check records flagged with catfish dummy
usda[usda$catfish == 1,]
## Check date data type
typeof(fda$REFUSAL_DATE)
## Convert to numeric
fda$date = as.Date(fda$REFUSAL_DATE, '%d-%b-%y')
## Check date data type
typeof(usda$received_lot_date)
## Convert to numeric
usda$date = as.Date(usda$received_lot_date, '%Y-%m-%d')
## Convert ISO Country Code to Long Name
fda$country = toupper(countrycode(fda$ISO_CNTRY_CODE, origin= 'iso2c', destination ='country.name'))
## Specify relevant variables to combine
fdaVars = c("catfish","date","country", "MFG_FIRM_FEI_NUM", "LGL_NAME", "ENTRY_NUM", "PRDCT_CODE_DESC_TEXT")
## Subset FDA data and add source
fdaSubset = fda[fdaVars]
## Create catfish dummy for FDA data
fda = mutate(fda, catfish = ifelse(fda$PRDCT_CODE_DESC_TEXT %in% fdaCatfish$Var1, 1, 0))
## Check records flagged with catfish dummy
fda[fda$catfish == 1,]
## USDA Species Category Description Frequency Table
usdaProducts = as.data.frame(table(usda$species_name))
## Check product categories given keyword searches
usdaCatfish = usdaProducts[grepl("Siluriformes", usdaProducts$Var1),]
## Create catfish dummy for USDA data
usda = mutate(usda, catfish = ifelse(usda$species_name %in% usdaCatfish$Var1, 1, 0))
## Check records flagged with catfish dummy
usda[usda$catfish == 1,]
## Specify relevant variables to combine
fdaVars = c("catfish","date","country", "MFG_FIRM_FEI_NUM", "LGL_NAME", "ENTRY_NUM", "PRDCT_CODE_DESC_TEXT")
## Subset FDA data and add source
fdaSubset = fda[fdaVars]
fdaSubset$source = "FDA"
## Specify relevant variables to combine
usdaVars = c("catfish","date","country", "export_establishment", "company_name" "app_lot_number", "product_category", "species_name")
## Specify relevant variables to combine
usdaVars = c("catfish","date","country", "export_establishment", "company_name", "app_lot_number", "product_category", "species_name")
## Subset FDA data and add source
usdaSubset = usda[usdaVars]
usdaSubset$source = "USDA"
compositeCountries = distinct(composite, country)
## Stack data subsets
composite = rbind.fill(fdaSubset, usdaSubset)
composite
compositeCountries = distinct(composite, country)
View(compositeCountries)
View(usda)
## Convert ISO Country Code to Long Name
usda$country_std = toupper(countrycode(usda$country, destination ='country.name'))
## Convert ISO Country Code to Long Name
usda$country_std = toupper(countrycode(usda$country, origin= 'country.name', destination= 'country.name'))
## Specify relevant variables to combine
fdaVars = c("catfish","date","country_std", "MFG_FIRM_FEI_NUM", "LGL_NAME", "ENTRY_NUM", "PRDCT_CODE_DESC_TEXT")
## Subset FDA data and add source
fdaSubset = fda[fdaVars]
## Convert ISO Country Code to Long Name
fda$country_std = toupper(countrycode(fda$ISO_CNTRY_CODE, origin= 'iso2c', destination= 'country.name'))
## Specify relevant variables to combine
fdaVars = c("catfish","date","country_std", "MFG_FIRM_FEI_NUM", "LGL_NAME", "ENTRY_NUM", "PRDCT_CODE_DESC_TEXT")
## Subset FDA data and add source
fdaSubset = fda[fdaVars]
fdaSubset$source = "FDA"
## Specify relevant variables to combine
usdaVars = c("catfish","date","country_std", "export_establishment", "company_name", "app_lot_number", "product_category", "species_name")
## Subset FDA data and add source
usdaSubset = usda[usdaVars]
usdaSubset$source = "USDA"
## Stack data subsets
composite = rbind.fill(fdaSubset, usdaSubset)
composite
compositeCountries = distinct(composite, country)
View(compositeCountries)
View(compositeCountries)
## Convert ISO Country Code to Long Name
usda$country_iso = toupper(countrycode(usda$country, origin= 'country.name', destination= 'iso2c'))
usda$country_std = toupper(countrycode(usda$country, origin= 'iso2c', destination= 'country.name'))
usda$country_std = toupper(countrycode(usda$country_iso, origin= 'iso2c', destination= 'country.name'))
## Specify relevant variables to combine
fdaVars = c("catfish","date","country_std", "MFG_FIRM_FEI_NUM", "LGL_NAME", "ENTRY_NUM", "PRDCT_CODE_DESC_TEXT")
## Subset FDA data and add source
fdaSubset = fda[fdaVars]
fdaSubset$source = "FDA"
## Specify relevant variables to combine
usdaVars = c("catfish","date","country_std", "export_establishment", "company_name", "app_lot_number", "product_category", "species_name")
## Subset FDA data and add source
usdaSubset = usda[usdaVars]
usdaSubset$source = "USDA"
## Stack data subsets
composite = rbind.fill(fdaSubset, usdaSubset)
composite
compositeCountries = distinct(composite, country)
compositeCountries = distinct(composite, country)
compositeCountries = distinct(composite, country_std)
View(compositeCountries)
## Export as RData
save(composite, file="output/build/compositeImportRefusal.RData")
## Export as CSV
write.csv(composite, file="output/build/compositeImportRefusal.CSV")
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
load("output/build/compositeImportRefusal.Rdata")
## Aggregate refusals to a daily level
daily = aggregate(composite$catfish, by=list(category= composite$date), FUN= sum)
## Create Year-Month variable for aggregation
composite$month = format(as.Date(composite$date),"%Y-%m")
## Aggregate refusals to a monthly level
monthly = aggregate(composite$catfish, by=list(category= composite$month), FUN= sum)
## Daily refusals over time period
ggplot(daily, aes(x= category, y= x)) +
geom_point() +
labs(x= "Year", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020 by Day") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5))
ggsave("output/figures/refusals/dailyImportRefusalAllCountries.png")
## Monthly refusals over time period
ggplot(monthly, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor All Countries") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2019-11", linetype= "dashed", color= "darkred") + annotate("text", x= "2019-12", y= 120, color= "darkred", label= "November 2019\nVietnam gains FSIS\nequivalence", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalAllCountries.png")
## Countries listed
compCountries = as.data.frame(table(composite$country))
## Aggregate refusals to a monthly level for Vietnam
compVietnam = composite[composite$country=="VIETNAM",]
monthlyVietnam = aggregate(compVietnam$catfish, by=list(category= compVietnam$month), FUN= sum)
## Monthly refusals over time period (Vietnam)
ggplot(monthlyVietnam, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor Vietnam") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2019-11", linetype= "dashed", color= "darkred") + annotate("text", x= "2019-12", y= 120, color= "darkred", label= "November 2019\nVietnam gains FSIS\nequivalence", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalVietnam.png")
## Aggregate refusals to a monthly level for China
compChina = composite[composite$country=="CHINA",]
monthlyChina = aggregate(compChina$catfish, by=list(category= compChina$month), FUN= sum)
## Monthly refusals over time period (China)
ggplot(monthlyChina, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor China") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalChina.png")
## Aggregate refusals to a monthly level for Thailand
compThailand = composite[composite$country=="THAILAND",]
monthlyThailand = aggregate(compThailand$catfish, by=list(category= compThailand$month), FUN= sum)
## Monthly refusals over time period
ggplot(monthlyThailand, aes(x= category, y= x, group= 1)) +
geom_line() +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nFor Thailand") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120) +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalThailand.png")
## Aggregate refusals to a monthly level for Thailand
compOther = composite[composite$country!="VIETNAM"&composite$country!="CHINA"&composite$country!="THAILAND",]
monthlyOther = aggregate(compOther$catfish, by=list(category= compOther$month), FUN= sum)
monthlyVietnam$country = "Vietnam"
monthlyChina$country = "China"
monthlyThailand$country = "Thailand"
monthlyOther$country = "All Other Countries"
## Merge all monthly data
monthlyByCountryLong= Reduce(function(x, y) rbind(x, y), list(monthlyVietnam, monthlyChina, monthlyThailand, monthlyOther))
monthlyByCountryLong$yearmon = as.numeric(parse_date_time(monthlyByCountryLong$category, orders= "ym"))
class(monthlyByCountryLong$yearmon)
## Monthly refusals over time period (Stacked Bar)
ggplot(monthlyByCountryLong, aes(x= category, y= x, fill= country)) +
geom_bar(position= "stack", stat= "identity") +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nBy Country", fill= "Country") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120)  +
geom_vline(xintercept= "2016-03", linetype= "dashed", color= "darkred") + annotate("text", x= "2016-04", y= 120, color= "darkred", label= "March 2016\nRegulatory power shifts to USDA", hjust= 0, vjust= 1) +
geom_vline(xintercept= "2017-09", linetype= "dashed", color= "darkred") + annotate("text", x= "2017-10", y= 120, color= "darkred", label= "September 2017\n18 month transition period ends", hjust= 0, vjust= 1)
ggsave("output/figures/refusals/monthlyImportRefusalByCountryBar.png")
## Monthly refusals over time period (Area Attempt)
ggplot(monthlyByCountryLong, aes(x= yearmon, y= x, fill= country)) +
geom_area(alpha= 0.5, color= 'black') +
labs(x= "Year-Month", y= "# Import Refusals of Catfish", title= "Catfish Import Refusals from January 2014 to September 2020\nBy Country", fill= "Country") +
theme(axis.text.x= element_text(angle= 90, vjust= 0.5)) +
ylim(0, 120)
ggsave("output/figures/refusals/monthlyImportRefusalByCountryArea.png")
avgRefusalsPrePostSep2017 =  function(data) {
pre = data[1:44,]
post = data[45:81,]
preAvg = mean(pre$x)
postAvg = mean(post$x)
deltaAvg = (postAvg - preAvg)/preAvg * 100
print(paste("The average number of import refusals before September 2017 is ", round(preAvg,2), "."))
print(paste("The average number of import refusals on and after September 2017 is ", round(postAvg,2), "."))
print(paste("After shifting authority to the USDA, the average number of refusals changed by ", round(deltaAvg,2), "%."))
}
avgRefusalsPrePostSep2017(monthly)
avgRefusalsPrePostSep2017(monthlyVietnam)
avgRefusalsPrePostSep2017(monthlyChina)
avgRefusalsPrePostSep2017(monthlyThailand)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
## Vertical join of USDA Archived & Current
usda = rbind(usdaCurrent, usdaArchived)
## Check for duplicates after row bind of Archived & Current
usda[duplicated(usda),]
## Check column names
colnames(usda)
## Update column names
names(usda)[names(usda) == "AppLot\r\nNumber"] = "app_lot_number"
names(usda)[names(usda) == "Country"] = "country"
names(usda)[names(usda) == "Received\r\nLot Date"] = "received_lot_date"
names(usda)[names(usda) == "Export\r\nEstablishment"] = "export_establishment"
names(usda)[names(usda) == "Company\r\nName"] = "company_name"
names(usda)[names(usda) == "HACCP\r\nCode"] = "HACCP_code"
names(usda)[names(usda) == "Product\r\nCategory"] = "product_category"
names(usda)[names(usda) == "Species\r\nName"] = "species_name"
names(usda)[names(usda) == "Final Weight\r\nRefused"] = "final_weight_refused"
names(usda)[names(usda) == "Refusal\r\nReasons"] = "refusal_reasons"
names(usda)[names(usda) == "Failed TOI"] = "failed_TOI"
names(usda)[names(usda) == "Defect\r\nDescriptions"] = "defect_desc"
## Check updated names
colnames(usda)
#fsis = extract_tables("FSIS/Siluriformes-Fish-Species-FSIS.pdf")
## FDA Product Description Frequency Table
fda$PRDCT_CODE_DESC_TEXT = tolower(fda$PRDCT_CODE_DESC_TEXT)
## FDA Product Description Frequency Table
fdaProducts = as.data.frame(table(fda$PRDCT_CODE_DESC_TEXT))
## Check product categories given keyword searches
fdaCatfish = fdaProducts[grepl("catfish", fdaProducts$Var1),]
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("pangasius", fdaProducts$Var1),]
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("siluriformes", fdaProducts$Var1),]
## Check product categories given keyword searches
fdaCatfish = fdaProducts[grepl("catfish", fdaProducts$Var1),]
fdaCatfish
## Create catfish dummy for FDA data
fda = mutate(fda, catfish = ifelse(fda$PRDCT_CODE_DESC_TEXT %in% fdaCatfish$Var1, 1, 0))
## Check records flagged with catfish dummy
fda[fda$catfish == 1,]
